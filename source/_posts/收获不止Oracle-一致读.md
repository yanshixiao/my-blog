---
title: 收获不止Oracle-一致读
date: 2018-05-25 14:41:33
tags: Oracle
categories: 收获不止Oracle
---

#### 一致读
##### SCN
System Change Number：只增不减的数字，记录块的改变，每当块数据变化时就会变化。
##### 数据库回滚段记录事务槽
事务槽（`ITL`）是用来分配回滚空间的，如果更新了某块，事务就被写进事务槽里。如果未提交或者回滚，该块就存在活动事务，数据库读到此块可以识别到这种情况的存在。

##### 实现
一般的，查询开始时的SCN大于等于查询中所有块的SCN就直接获取数据。如果小于，说明在查询这段时间中，数据发生了变化，需要根据ITL槽中记录了对应的undo块的地址找到undo块，读取修改前的值。

读过的块不管SCN大小都不会去重新查。

并不是查询开始的SCN大于等于查询中所有块的SCN就一定可以直接获取数据，因为会有别的用户修改数据，更新未提交（`存在活动事务`）。这时还是要去读回滚段的数据。

##### 总结
Oracle在做一致读时，首先看发起的SCN是否大于当前查询块的SCN，如果小于，毫无疑问从回滚段获取前镜像数据。如果SCN确实大于当前查询块的SCN，还要却把该块没有活动事务，否则还是要去前镜像查找。