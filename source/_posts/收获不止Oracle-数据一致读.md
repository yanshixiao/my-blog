---
title: 收获不止Oracle-数据一致读
date: 2018-03-14 18:18:30
tags: Oracle 数据一致读
categories: 收获不止Oracle
---

### 一致读

查询的记录由查询的那一时刻决定，后面即便变化了，也要根据回滚段保存的前镜像记录，取到当时时间点的数据。

##### 原理

首先需要了解两点

1. SCN（System Change Number）。这是一个递增的数字，存在于Oracle的最小单位块里，当某块改变时SCN就会递增。

2. 数据库的回滚事务槽（分配回滚空间），如果更新了某块，事务就被写入事务槽中。如果未提交或回滚，该块就存在活动事务，数据库读到该块时可以识别此种情况。

<!--more-->

![举个栗子](/images/common/jugelizi.jpg)

1234四个块，读到第三个时，第四个在这期间已变化，块4的ITL槽中SCN会大于查询时的SCN，就会根据ITL中记录的undo块地址找到undo块，读取undo块中被修改前的旧的（正确的）数据，至于123块因为已经读过了，就不会再回头再读。

不过并不是查询开始的SCN大于查询中的SCN就一定可以直接获取数据。如果有别的用户中途修改过数据未提交，也就是存在**活动事务**，依旧不会直接读取块中的数据。8点读，7点半更新了7点的数据但未提交，仍然会依据undo读取7点的数据。

Oracle在一致读的时候，首先看发起的SCN是否大于当前查询块的SCN，如果小于，毫无疑问从回滚段获取前镜像数据。如果SCN确实大于当前查询块的SCN，还要确保该块有没有活动事务，否则还是要去回滚段获取前镜像数据。